# Contents
- [Contents](#contents)
- [Prerequisites Installation](#prerequisites-installation)
  - [1. Install Docker (Source):](#1-install-docker-source)
  - [2. Install Nividia Docker (Source):](#2-install-nividia-docker-source)
  <!-- - [3. Docker Compose Installation (Source):](#3-docker-compose-installation-source) -->
- [Creating the Docker Container](#creating-the-docker-container)
  - [Run interactive prompt of `create_cuda_docker.py`](#example-option-1-use-the-interactive-prompting-of-create_cuda_dockerpy-to-generate-the-config)
  - [Specify specific flags of `create_cuda_docker.py`](#example-option-2-use-create_cuda_dockerpy-arguments-to-generate-config)
  - [Use default settings of `create_cuda_docker.py`](#example-option-3-use-default-flags)
- [Start the Docker Container](#start-the-container)
  - [(Optional): Install starting container script](#install-start-container-script-and-its-bash-completion)

# Prerequisites Installation
## 1. Install Docker [(Source)](https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository):
<!-- Create a directory that you will be using as the home directory for the docker installation. -->
<!-- ```bash -->
<!-- export DOCKER_USER_HOMEDIR=~/docker_homes -->
<!-- mkdir -p $DOCKER_USER_HOMEDIR -->
<!-- ``` -->
<!-- ```bash -->
<!-- # remove previous Docker installations -->
<!-- sudo apt-get remove docker docker-engine docker.io containerd runc -->

<!-- # Setup Docker apt repository -->
<!-- #curl -fsSL https://download.docker.com/linux/ubuntu/gpg > misc/docker.key -->
<!-- sudo apt-key add misc/docker.key -->

<!-- sudo add-apt-repository \ -->
<!--    "deb [arch=amd64] https://download.docker.com/linux/ubuntu \ -->
<!--    $(lsb_release -cs) \ -->
<!--    stable" -->
<!-- sudo apt-get update -->
<!-- sudo apt-get install docker-ce docker-ce-cli containerd.io -->
<!-- # Setup user to have access to Docker without sudo -->
<!-- sudo groupadd docker -->
<!-- sudo usermod -aG docker $USER -->
<!-- ``` -->
<!-- After adding your user to the docker group, it is important step to log out and back in to update your user groups. -->

## 2. Install Nividia Docker [(Source)](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#docker):

<!-- ```bash -->
<!-- # Setup Nvidia Docker apt repository -->
<!-- # curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey > misc/nvidia.key -->
<!-- sudo apt-key add misc/nvidia.key -->
<!-- # distribution=$(. /etc/os-release;echo $ID$VERSION_ID) && curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list > misc/nvidia-docker.list -->
<!-- cat misc/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list -->
<!-- sudo apt update -->
<!-- sudo apt install nvidia-docker2 -->
<!-- sudo systemctl restart docker -->
<!-- ``` -->

<!-- We should now be able to download a CUDA docker image and see if it is working by running `nvidia-smi` inside of it: -->
<!-- ```bash -->
<!-- nvidia-docker run --rm nvidia/cuda:11.2.0-devel-ubuntu20.04 nvidia-smi -->
<!-- docker run --rm --runtime=nvidia nvidia/cuda:11.2.0-devel-ubuntu20.04 nvidia-smi -->
<!-- docker run --rm --gpus all nvidia/cuda:11.2.0-devel-ubuntu20.04 nvidia-smi -->
<!-- ``` -->

<!-- ## 3. Docker Compose Installation [(Source)](https://docs.docker.com/compose/install/):

Docker-compose is a nice wrapper for creating Docker containers that is used to setup displays and users inside of the docker container.
```bash
curl -SL "https://github.com/docker/compose/releases/download/v2.12.2/docker-compose-$(uname -s)-$(uname -m)" -o ~/.local/bin/docker-compose
chmod +x ~/.local/bin/docker-compose
``` -->

# Creating the Docker container
## Prequisites
* install `jq` using `sudo apt install jq` as this is needed to get docker tags

We use `docker compose` with various arguments that need to be filled to build the Docker Image.
The arguments are read from a `.env` file that is generated by `create_cuda_docker.py`
## Create docker container config using `create_cuda_docker.py`:

By default, `create_cuda_docker.py` will use a DATA_PATH of `/data`, and a WORKSPACE_PATH of `~/workspaces`.  If you don't have access to `/data` it is recommended that you change those parameters. You can do this with the following flags or by using the interactive prompt when running `create_cuda_docker.py`

```
usage: create_cuda_docker.py [-h] [-d] [--ubuntu UBUNTU] [-c CUDA] [-b] [--data_path DATA_PATH] [--workspace_path WORKSPACE_PATH] [-u]

Script to help configure the docker container by rewriting the .env file used by docker compose for building. It will automatically set up the current user and their home directory as
available in the docker container.

optional arguments:
  -h, --help            show this help message and exit
  -d, --default         Use default version of Cuda and Paths
  --ubuntu UBUNTU       Version of Ubuntu to use (Default: 22.04)
  -c CUDA, --cuda CUDA  Version of CUDA to use (Default: 11.8.0)
  -b, --build           Build docker container in addition to configuring it (Builds cans take around 30 minutes)
  --data_path DATA_PATH
                        Which host OS folder to link to docker container as /data (Default: /data/)
  --workspace_path WORKSPACE_PATH
                        Which host OS folder to link to docker container as ~/workspaces (Default: ~/workspaces/)
  -u, --user            Use current user as the username in the docker container
```

### Example Option 1: Use the interactive prompting of `create_cuda_docker.py` to generate the config
`create_cuda_docker.py` has an interactive prompt when ran on its own:
```bash
# Use the interactive prompting to fill the .env file
./create_cuda_docker.py

# Create the docker image and container from .env config
docker compose up --no-start --build
```

### Example Option 2: Use `create_cuda_docker.py` arguments to generate config

Create the docker image.  Note that currently the image uses your username and id to create a non-sudo user.
```bash
# Create directories for data and workspaces. You can also point to existing paths if desired
mkdir -p ${HOME}/data
mkdir -p ${HOME}/workspaces

# create the docker .env file
./create_cuda_docker.py -c 11.8.0 --user --data_path ${HOME}/data --workspace_path ${HOME}/workspaces

# Build the docker image
docker compose up --no-start --build
```

### Example Option 3: Use default flags

* To create link the `./create_cuda_docker.py --default`
* run `docker compose up --no-start --build` (might take a while to build the docker image the first time - maybe 20 minutes?)
* run `./docker_bash.sh ros2_cuda` to be dropped inside the container and to open multiple terminals into the same container

## Start the container
We also provide a script to start a container if is currently stopped and provide a bash prompt into the container.
```bash
# To start a bash session inside the container run:
./docker_bash.sh ros2_cuda
# docker_bash.sh may be used repeatedly in other terminals to get multiple shells in the docker container.
```
### Install start container script and its bash completion
We have a bash completion file as well for so that you can TAB between available docker containers. To install
both the container launching script and its bash completion locally, you can do the following:
```bash
# Make folders in case they don't exist
mkdir -p $HOME/.local/bin
mkdir -p $HOME/.bash_completions

# symlink files to these locations to install script and bash completion
# Assuming you are in MPPI_Paper_Example_Code/docker/
ln -rs docker_bash.sh $HOME/.local/bin/docker_bash.sh
ln -rs misc/docker_bash-completion.bash $HOME/.bash_completions/docker_bash-completion.bash

# setup .bashrc to point to local installations
cat << EOF >> $HOME/.bashrc
if [ -d \$HOME/.bash_completions ]; then
  for f in \$HOME/.bash_completions/*; do
    source \$f
  done
fi
EOF

echo "export PATH=\$HOME/.local/bin:\$PATH" >> $HOME/.bashrc
source $HOME/.bashrc
```
